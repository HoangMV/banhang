<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shop Nhà Ngố - Báo Cáo Mua Hàng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 16px;
            color: #333;
            touch-action: manipulation;
        }

        header {
            background: linear-gradient(135deg, #4a90e2, #5651e5);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        header p {
            margin: 5px 0;
            font-size: 14px;
            opacity: 0.9;
        }

        main {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        h2 {
            color: #4a90e2;
            font-size: 19px;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        thead {
            background-color: #f6f8fa;
        }

        th {
            font-weight: 600;
            color: #4a4a4a;
            text-transform: uppercase;
            font-size: 12px;
        }

        tbody tr:hover {
            background-color: #f5f8ff;
        }

        .quantity-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quantity-group span {
            flex: 1;
            text-align: center;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn {
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 4px;
        }

        .quantity-btn:hover {
            background-color: #357abd;
        }

        .quantity-input {
            width: 30px;
            text-align: center;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px;
        }

        .over-purchased {
            color: #e74c3c;
            font-weight: bold;
        }

        img {
            border-radius: 4px;
            object-fit: cover;
            width: 50px;
            height: 50px;
            display: block;
        }

        @media (max-width: 600px) {
            th, td {
                padding: 8px;
            }

            .quantity-group {
                flex-direction: column;
            }

            .quantity-group span {
                margin: 2px 0;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }

        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .search-filter {
            margin-bottom: 20px;
        }

        .search-filter input, .search-filter select {
            padding: 5px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Shop Nhà Ngố</h1>
        <p>Địa Chỉ: 21 Linh Đường - Linh Đàm - Hà Nội</p>
        <p>Điện Thoại: 0986 857 087</p>
    </header>

    <main>
        <h2>BÁO CÁO MUA HÀNG TỔNG HỢP</h2>
        <div class="search-filter">
            <input type="text" id="searchInput" placeholder="Tìm kiếm...">
            <select id="groupFilter">
                <option value="">Tất cả nhóm</option>
                <!-- Các option sẽ được thêm động bằng JavaScript -->
            </select>
        </div>
        <div id="reportContent">
            <p class="loading">Đang tải dữ liệu...</p>
        </div>
        <div class="pagination">
            <button id="prevPage">Trước</button>
            <span id="pageInfo"></span>
            <button id="nextPage">Sau</button>
        </div>
    </main>

    <script>
        const APP_ID = '90034787-3238-4f94-b368-59d264db6cb9';
        const API_KEY = 'V2-wdLR9-jwplY-BZu1d-nsReC-xzo1F-ISECp-yEKYv-CLdhq';
        const SHEET_NAME_2 = 'Kho';
        let allData = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        function apiRequest(tableName, action, data) {
            const apiUrl = `https://www.appsheet.com/api/v2/apps/${APP_ID}/tables/${tableName}/Action`;
            return $.ajax({
                url: apiUrl,
                method: 'POST',
                headers: {
                    'ApplicationAccessKey': API_KEY,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    Action: action,
                    Properties: {
                        Locale: 'vi-VN',
                        Timezone: 'Asia/Ho_Chi_Minh'
                    },
                    ...data
                })
            });
        }

        async function fetchCombinedData() {
            try {
                const [khoData, chiTietBanHangData] = await Promise.all([
                    apiRequest('Kho', 'Find', { Rows: [], Properties: { Selector: 'Filter(Kho, [Số lượng cần mua]>0)' } }),
                    apiRequest('Chi tiết bán hàng', 'Find', { Rows: [], Properties: { Selector: 'Filter(Chi tiết bán hàng, true)' } })
                ]);
                
                return khoData.map(item => ({
                    ...item,
                    ...chiTietBanHangData.find(detail => detail['SKU'] === item['SKU']) || {}
                }));
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                throw error;
            }
        }

        function createTableHTML(data) {
            let tableHTML = `
                <div style="overflow-x: auto;">
                    <table id="purchaseTable">
                        <thead>
                            <tr>
                                <th>Stt</th>
                                <th>Hình Ảnh</th>
                                <th>Tên Hàng Hóa</th>
                                <th>
                                    <div class="quantity-group">
                                        <span>Cần Mua</span>
                                        <span>Đã Mua</span>
                                        <span>Còn Lại</span>
                                    </div>
                                </th>
                                <th>Trạng thái</th>
                                <th>Ghi Chú</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach((item, index) => {
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><img src="https://www.appsheet.com/template/gettablefileurl?appName=QLBánhàng-2154080-24-08-14&tableName=${SHEET_NAME_2}&fileName=${item['Ảnh sản phẩm']}" alt="Ảnh"></td>
                        <td>${item['Tên sản phẩm'] || ''}</td>
                        <td>
                            <div class="quantity-group">
                                <span>${item['Số lượng cần mua'] || 0}</span>
                                <div class="quantity-control">
                                    <button class="quantity-btn" onclick="changeQuantity(${index}, -1)">-</button>
                                    <input type="number" class="quantity-input" value="0" min="0" onchange="updateQuantity(this, ${index})">
                                    <button class="quantity-btn" onclick="changeQuantity(${index}, 1)">+</button>
                                </div>
                                <span>${(item.SoLuongCanMua || 0) }</span>
                            </div>
                        </td>
                        <td>${item.TrangThai || ''}</td>
                        <td>${item.GhiChu || ''}</td>
                    </tr>
                `;(item['Số lượng cần mua'] > 0)  // Thêm điều kiện này(item['Số lượng cần mua'] > 0)  // Thêm điều kiện này
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            return tableHTML;
        }

        function updateTable() {
            const searchTerm = $('#searchInput').val().toLowerCase();
            const selectedGroup = $('#groupFilter').val();
            updateTable
            const filteredData = allData.filter(item => 
                (item['Tên sản phẩm'].toLowerCase().includes(searchTerm) || 
                 item['SKU'].toLowerCase().includes(searchTerm)) &&
                (selectedGroup === '' || item['Nhóm Sản Phẩm'] === selectedGroup)
            );

            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, startIndex + itemsPerPage);

            $('#reportContent').html(createTableHTML(paginatedData));
            updatePagination(filteredData.length);
        }

        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            $('#pageInfo').text(`Trang ${currentPage} / ${totalPages}`);
            $('#prevPage').prop('disabled', currentPage === 1);
            $('#nextPage').prop('disabled', currentPage === totalPages);
        }

        async function initializeReport() {
            try {
                allData = await fetchCombinedData();
                updateTable();
                populateGroupFilter();
            } catch (error) {
                $('#reportContent').html(`<p class="error">Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại sau.</p>`);
            }
        }

        function populateGroupFilter() {
            const groups = [...new Set(allData.map(item => item['Nhóm Sản Phẩm']))];
            const select = $('#groupFilter');
            groups.forEach(group => {
                if (group) {
                    select.append($('<option>', {
                        value: group,
                        text: group
                    }));
                }
            });
        }

        function changeQuantity(index, change) {
            const input = $(`#purchaseTable .quantity-input`).eq(index);
            let value = parseInt(input.val()) || 0;
            value += change;
            if (value < 0) value = 0;
            input.val(value);
            updateQuantity(input[0], index);
        }

        function updateQuantity(input, index) {
            const value = parseInt($(input).val()) || 0;
            const item = allData[index];
            const remaining = item['Số lượng cần mua'] - value;
            $(input).closest('tr').find('.quantity-group span:last-child').text(remaining);
            
            if (remaining < 0) {
                $(input).closest('tr').addClass('over-purchased');
            } else {
                $(input).closest('tr').removeClass('over-purchased');
            }
        }

        $(document).ready(function() {
            initializeReport();

            $('#searchInput, #groupFilter').on('input change', function() {
                currentPage = 1;
                updateTable();
            });

            $('#prevPage').click(function() {
                if (currentPage > 1) {
                    currentPage--;
                    updateTable();
                }
            });

            $('#nextPage').click(function() {
                const totalPages = Math.ceil(allData.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    updateTable();
                }
            });
        });
    </script>
</body>
</html>
